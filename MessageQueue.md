### 常见的消息队列对比

|                |                        RabbitMQ                        |                ActiveMQ                 |         RocketMQ         |                     Kafka                      |
| :------------: | :----------------------------------------------------: | :-------------------------------------: | :----------------------: | :--------------------------------------------: |
|    公司社区    |                         Rabbit                         |                 Apache                  |           阿里           |                     Apache                     |
|    开发语言    |                         Erlang                         |                  Java                   |           Java           |                   Scala&Java                   |
|    协议支持    |                  AMQP,XMPP,SMTP,STOMP                  |      OpenWire,STOMP,REST,XMPP,AMQP      |          自定义          |       自定义协议，社区封装了http协议支持       |
| 客户端支持语言 |     官方支持Erlang、Java、Ruby等，几乎支持所有语言     | Java、C、C++、Python、PHP、Perl、.net等 |   Java、C++（不成熟）    | 官方支持Java，社区产出多种API，如PHP、Python等 |
|   单机吞吐量   |                      万级（其次）                      |              万级（最差）               |      十万级（最好）      |                 十万级（次之）                 |
|    消息延迟    |                         微秒级                         |                 毫秒级                  |          毫秒级          |                    毫秒以内                    |
|    功能特性    | 并发能力强，性能及其好，延时低，社区活跃，管理界面丰富 |      老牌产品，成熟度高，文档较多       | MQ功能较为完善，扩展性佳 | 只支持主要的MQ功能，毕竟是为大数据领域准备的。 |

### 消息队列的优势和劣势

优势：

1. 应用解耦：提高系统容错性和可维护性

2. 异步提速：提升用户体验和系统吞吐量
3. 削峰填谷：提升系统稳定性

劣势：

1. 系统可用性降低

系统引入的外部依赖越多，系统稳定性就越差。一旦MQ宕机，就会对业务造成影响。

2. 系统复杂度提高

MQ的引入大大增加了系统的复杂性，以前系统间是同步的远程调用，现在是通过MQ进行异步调用。

3. 一致性问题

A系统处理完业务，通过MQ给B、C、D三个系统发消息数据，如果B、C处理成功，但是D处理失败。如何保证消息数据处理的一致性？

### Kafka

Kafka 是一种分布式的，基于发布 / 订阅的消息系统。主要设计目标如下：

- 以时间复杂度为 O(1) 的方式提供消息持久化能力，即使对 TB 级以上数据也能保证常数时间复杂度的访问性能。
- 高吞吐率。即使在非常廉价的商用机器上也能做到单机支持每秒 100K 条以上消息的传输。
- 支持 Kafka Server 间的消息分区，及分布式消费，同时保证每个 Partition 内的消息顺序传输。
- 同时支持离线数据处理和实时数据处理。
- Scale out：支持在线水平扩展。

#### 基本概念

1. 主题（Topic）和分区（Partition）

在 Kafka 中，消息以**主题（Topic）**来分类，每一个主题都对应一个「消息队列」，这有点儿类似于数据库中的表。但是如果我们把所有同类的消息都塞入到一个“中心”队列中，势必缺少可伸缩性，无论是生产者/消费者数目的增加，还是消息数量的增加，都可能耗尽系统的性能或存储。

2. Broker和集群

一个 Kafka 服务器也称为 Broker，它接受生产者发送的消息并存入磁盘；Broker 同时服务消费者拉取分区消息的请求，返回目前已经提交的消息。使用特定的机器硬件，一个 Broker 每秒可以处理成千上万的分区和百万量级的消息。

若干个 Broker 组成一个集群（Cluster），其中集群内某个 Broker 会成为集群控制器（Cluster Controller），它负责管理集群，包括分配分区到 Broker、监控 Broker 故障等。在集群内，一个分区由一个 Broker 负责，这个 Broker 也称为这个分区的 Leader；当然一个分区可以被复制到多个 Broker 上来实现冗余，这样当存在 Broker 故障时可以将其分区重新分配到其他 Broker 来负责。